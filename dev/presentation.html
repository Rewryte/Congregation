<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Congregation</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
  <div id="LoadView" class="container position-absolute top-50 start-50 translate-middle">
    <h1 class="text-center">Loading <div class="spinner-border" role="status"></div></h1>
  </div>
  <div id="TextView" class="container position-absolute top-50 start-50 translate-middle" style="display: none;">
    <h1 id="Title" class="text-center">test</h1>
    <ul id="BulletList" class="list-group"></ul>
  </div>
  <div id="WebView" class="container-fluid vw-100 vh-100 bg-black overflow-hidden" style="display: none;"><iframe id="WebIframe" class="vw-100 vh-100"></iframe></div>
  <img id="ImageView" class="vw-100 vh-100 object-fit-contain bg-black" style="display: none;" alt="image viewer">
  <script>
    function SwitchView( View ) {
      document.getElementById( "LoadView" ).style.display = "none";
      document.getElementById( "WebView" ).style.display = "none";
      document.getElementById( "TextView" ).style.display = "none";
      document.getElementById( "ImageView" ).style.display = "none";
      document.getElementById( View ).style.display = "";
    }
    function HandleText( TextStr ) {
      // Multiple bullet points are separated with double dashes
      const TextArr = TextStr.split( "--" );
      // First point used as title
      document.getElementById( "Title" ).innerText = TextArr.shift();
      document.getElementById( "BulletList" ).innerHTML = "";
      // Make an element for each remaining bullet point
      TextArr.forEach( ( BulletStr ) => {
        const ListItem = document.createElement( "li" );
        ListItem.className = "list-group-item";
        ListItem.textContent = BulletStr;
        document.getElementById( "BulletList" ).appendChild( ListItem );
      });
      SwitchView( "TextView" );
    }
    function HandleURL( url ) {
      document.getElementById( "WebIframe" ).src = url;
      SwitchView( "LoadView" );
    }
    function HandleImage( data ) {
      document.getElementById( "ImageView" ).src = data;
      SwitchView( "ImageView" );
    }

    var Connection;
    function Connect( NewConnection ) {
      console.log( "New connection received" );
      // Do not connect if connection already exists
      if ( Connection ) { return; }
      Connection = NewConnection;
      // Add connection events
      Connection.onmessage = ( Message ) => {
        var data = JSON.parse( Message.data );
        switch( data[0] ) {
          case "text":
            HandleText( data[1] );
            break;
          case "url":
            HandleURL( data[1] );
            break;
          case "image":
            HandleImage( data[1] );
            break;
          default:
            console.log( "Invalid message received: " + Message.data )
        }
      };
      console.log( "Sending ready message" );
      Connection.send( "load" );
    }

    window.addEventListener( "load", () => {
      // When loaded, handle incoming connections
      navigator.presentation.receiver.connectionList.then( ( ConnList ) => {
        if ( ConnList.connections[0] ) {
          Connect( ConnList.connections[0] );
        } else {
          ConnList.onconnectionavailable = ( Event ) => { Connect( Event.connection ); };
        }
      });
    });

    document.getElementById( "WebIframe" ).addEventListener( "load", () => {
      SwitchView( "WebView" );
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>