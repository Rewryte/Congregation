<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Congregation</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body style="transition: background 0.5s, color 0.5s;">
  <div id="PresentationPreview" class="container p-0 border border-2 overflow-hidden" style="max-width: 960px;max-height: 720px;height: 50vh;">
    <div id="PresentationElement" class="bg-black overflow-hidden" style="width: 100%;height: 100%">
      <div id="LoadView" class="position-relative top-50 start-50 translate-middle text-center" style="">
          <h1 class="display-2">Congregation</h1>
          <div class="fs-3">Instant Presentations</div><br>
          <div class="spinner-border text-primary" role="status"></div>
      </div>
      <div id="TextView" class="position-relative top-50 start-50 translate-middle" style="display: none;transform-origin: top left;transition: width 2s, height 2s, scale 2s;">
          <h1 id="Title" class="display-2 text-center"></h1>
          <ul id="BulletList" class="list-group list-group-flush"></ul>
      </div>
      <iframe id="WebView" class="overflow-hidden" style="height: 100%;width: 100%;scale: 1;transform-origin: top left;transition: width 2s, height 2s, scale 2s;display: none;"></iframe>
      <iframe id="FullWebView" class="overflow-hidden" style="height: 100%;width: 100%;display: none;"></iframe>
      <img id="ImageView" class="object-fit-contain" style="height: 100%;width: 100%;display: none;scale: 1;transition: width 2s, height 2s, scale 2s;" alt="image viewer">
      <video id="VideoView" class="" style="height: 100%;width: 100%;display: none;" controls autoplay></video>
    </div>
  </div>
  <div class="container">
    <h3>Select presentation display from the list below</h3>
    <div id="DisplayList" class="list-group">
      <button id="DisplayBtnTemplate" type="button" class="list-group-item list-group-item-action list-group-item-primary" style="display: none;"></button>
    </div>
  </div>
  <script>
    var CurrentView = "LoadView";
    var CurrentZoom = 1;
    function SwitchView( View ) {
      console.log( "Changing view to " + View );
      // Reset zoom when changing modes
      if ( View != "LoadView" && View != CurrentView ) {
        CurrentView = View;
        CurrentZoom = 1;
        ZoomView( CurrentZoom );
      }
      document.getElementById( "LoadView" ).style.display = "none";
      document.getElementById( "WebView" ).style.display = "none";
      document.getElementById( "FullWebView" ).style.display = "none";
      document.getElementById( "TextView" ).style.display = "none";
      document.getElementById( "ImageView" ).style.display = "none";
      document.getElementById( "VideoView" ).style.display = "none";
      document.getElementById( View ).style.display = "";
    }

    function ZoomView( ZoomFloat = 1 ) {
      console.log( "Changing zoom level to " + ZoomFloat );
      var TargetElement, TargetWidth, TargetHeight, TargetScale;
      switch ( CurrentView ) {
        case "LoadView":
          TargetElement = document.getElementById( "LoadView" );
          // Fit to viewport
          TargetScale = Math.min( window.innerWidth / 960, window.innerHeight / 720 );
          TargetElement.style.scale = ( TargetScale * 100 ) + "%";
          break;
        case "TextView":
          TargetElement = document.getElementById( "TextView" );
          TargetElement.style.scale = ( ZoomFloat * 100 ) + "%";
          break;
        case "WebView":
          TargetElement = document.getElementById( "WebView" );
          // Fix width but maintain aspect ratio
          TargetWidth = Math.floor( 960 / ZoomFloat );
          TargetHeight = Math.floor( TargetWidth / TargetElement.parentNode.Width * TargetElement.parentNode.Height );
          // Fit to viewport
          TargetScale = TargetElement.parentNode.Width / TargetWidth;
          TargetElement.style.width = TargetWidth + "px";
          TargetElement.style.height = TargetHeight + "px";
          TargetElement.style.scale = ( TargetScale * 100 ) + "%";
          break;
        case "ImageView":
          TargetElement = document.getElementById( "ImageView" );
          TargetElement.style.scale = ( ZoomFloat * 100 ) + "%";
          break;
      }
    }

    function SetDarkMode( DarkMode ) {
      ( DarkMode == "true" ) ? document.documentElement.setAttribute( "data-bs-theme", "dark" ) : document.documentElement.setAttribute( "data-bs-theme", "light" );
    }

    function HandleText( TextStr ) {
      // Multiple bullet points are separated with double dashes
      const TextArr = TextStr.split( "--" );
      // First point used as title
      document.getElementById( "Title" ).innerText = TextArr.shift();
      document.getElementById( "BulletList" ).innerHTML = "";
      // Make an element for each remaining bullet point
      TextArr.forEach( ( BulletStr ) => {
        const ListItem = document.createElement( "li" );
        ListItem.className = "list-group-item fs-3";
        ListItem.textContent = BulletStr;
        document.getElementById( "BulletList" ).appendChild( ListItem );
      });
      SwitchView( "TextView" );
    }
    function HandleURL( url ) {
      document.getElementById( "WebView" ).src = url;
      SwitchView( "LoadView" );
    }
    function HandleURLFullRes( url ) {
      document.getElementById( "FullWebView" ).src = url;
      SwitchView( "LoadView" );
    }
    function HandleImage( data ) {
      document.getElementById( "ImageView" ).src = data;
      SwitchView( "ImageView" );
    }
    function HandleVideo( data ) {
      document.getElementById( "VideoView" ).src = data;
      SwitchView( "VideoView" );
      document.getElementById( "VideoView" ).load();
    }

    window.addEventListener( "message", ( Event ) => {
      var data = JSON.parse( Event.data );
      switch( data[0] ) {
        case "text":
          HandleText( data[1] );
          break;
        case "url":
          HandleURL( data[1] );
          break;
        case "urlfullres":
          HandleURLFullRes( data[1] );
          break;
        case "image":
          HandleImage( data[1] );
          break;
        case "video":
          HandleVideo( data[1] );
          break;
        case "zoomin":
          CurrentZoom = Math.min( CurrentZoom + 0.2 , 5 );
          ZoomView( CurrentZoom );
          break;
        case "zoomout":
          CurrentZoom = Math.max( CurrentZoom - 0.2 , 0.2 );
          ZoomView( CurrentZoom );
          break;
        case "darkmode":
          SetDarkMode( data[1] );
          break;
        default:
          console.log( "Invalid message received: " + Message.data )
      }
    });

    async function PopulateDisplays() {
      ScreenDetails = await window.getScreenDetails();
      ScreenDetails.screens.forEach( ( Screen, Index ) => {
        const NewButton = document.getElementById( "DisplayBtnTemplate" ).cloneNode(true);
        const DisplayName = ( Screen.label ) ? Screen.label : ( Screen.isInternal ) ? "Built-in Display" : "Display " + Index;
        NewButton.textContent = ( Screen.isPrimary ) ? DisplayName + " (Main)" : DisplayName;
        NewButton.onclick = () => SetDisplay( Screen );
        NewButton.style.display = "";
        document.getElementById( "DisplayList" ).appendChild( NewButton );
      });
    }

    function SetDisplay( Screen ) {
      document.getElementById( "PresentationElement" ).requestFullscreen( { screen: Screen } );
    }

    window.addEventListener( "load", () => {
      PopulateDisplays();
    });

    document.addEventListener( "fullscreenchange", () => {
      // Close window when presentation exits fullscreen mode
      if ( !document.fullscreenElement ) { close(); }
    });

    document.getElementById( "WebView" ).addEventListener( "load", () => {
      SwitchView( "WebView" );
    });

    document.getElementById( "FullWebView" ).addEventListener( "load", () => {
      SwitchView( "FullWebView" );
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>